(function(){"use strict";var t=new springroll.ApplicationPlugin;t.preload=function(t){var i=function(t,e){if(t instanceof Function){return t.bind(this)(e)}return t}.bind(this);var n={options:{}};var o=function(t){Object.keys(t).forEach(function(e){if(e==="options"){Object.keys(t[e]).forEach(function(i){n.options[i]=t[e][i]})}else{n[e]=t[e]}})};if(this.config.alp){o(this.config.alp)}if(this.options.alp){o(this.options.alp)}e(this.container,n,function(e){var n=e.recType;var o=e.recParams;var r=e.recCallback;var a=e.gameUri;var s=e.eventOverride;var c=this.learning.catalog.events||{};var u=KidaptiveSdk.KidaptiveUtils.copyObject(e.options)||{};u.autoFlushCallbacks=u.autoFlushCallbacks||[];u.autoFlushCallbacks.splice(0,0,function(t){t.then(function(){if(!KidaptiveSdk.getCurrentUser()&&!KidaptiveSdk.isAnonymousSession()){KidaptiveSdk.startAnonymousSession()}})});KidaptiveSdk.init(e.apiKey,e.version,u).then(function(t){var u={};this.alpPlugin={sdk:t,getRecommendation:function(e){var s=t.KidaptiveUtils.copyObject(i(n,e)||"optimalDifficulty");var c=t.KidaptiveUtils.copyObject(i(o,e))||{};c.learnerId=t.getLearnerList()[0].id;c.game=a;var u;switch(s){case"random":u=t.getRandomRecommendations(c);break;case"optimalDifficulty":u=t.getOptimalDifficultyRecommendations(c);break;default:u=t.getRecommendations(s,c)}return r?r.bind(this)(u,e):u}.bind(this),getState:function(){return t.KidaptiveUtils.copyObject(u)},setState:function(e){Object.keys(e).forEach(function(t){if(e[t]===undefined){delete u[t]}});e=t.KidaptiveUtils.copyObject(e);Object.keys(e).forEach(function(t){u[t]=e[t]})},getInitParams:function(){return KidaptiveSdk.KidaptiveUtils.copyObject(e,true)}};if(!e.options.noOidc&&this.container){var l=function(e){if(t.KidaptiveUtils.getObject(e,["data","name"])!=="Kidaptive ALP"){return}var i;t.init().then(function(){i=t.KidaptiveUtils.getObject(t.getCurrentUser(),"id");if(t.isAnonymousSession()){t.logoutUser()}return t.refresh()}).then(function(){var e=t.KidaptiveUtils.getObject(t.getCurrentUser(),"id");if(!e){throw new Error}if(e!==i){u={}}}).catch(function(){t.logoutUser();t.startAnonymousSession().then(function(){u={}})})};var d=function(e){if(t.KidaptiveUtils.getObject(e,["data","name"])!=="Kidaptive ALP"){return}t.init().then(function(){if(!t.isAnonymousSession()){t.logoutUser();t.startAnonymousSession().then(function(){u={}})}})};var f=function(){t.init().then(function(){if(t.isAnonymousSession()){t.logoutUser()}t.logoutUser();t.startAnonymousSession().then(function(){u={}})})};this.container.on("openIdAuthSuccess",l);this.container.on("openIdRefreshAuthSuccess",l);this.container.on("openIdAuthFailure",d);this.container.on("openIdRefreshAuthFailure",d);this.container.on("openIdAllLogoutsComplete",f)}if(this.learning){var v=function(e){if(!t.getCurrentUser()){return}var i=c[e.event_data.event_code]||"Springroll Event";var n=t.KidaptiveUtils.copyObject(e.event_data);var o={additionalFields:n};o.gameUri=a;o.learnerId=t.getLearnerList()[0].id;for(var r in n){if(r==="duration"&&typeof n[r]==="number"){o[r]=n[r]/1e3;delete n[r]}else if(n[r]instanceof Object){n[r]=t.KidaptiveUtils.toJson(n[r])}else{n[r]=n[r].toString()}}n.session_id=e.game_session;n.springroll_game_id=e.game_id;n.springroll_event_id=e.event_id;n.springroll_event_code=n.event_code;delete n.event_code;return{eventName:i,args:o}};var p=function(e){var i=v(e);if(i){t.reportBehavior(i.eventName,i.args)}};var h=(s||p).bind(this);this.learning.on("learningEvent",function(t){h(t,p,v)}.bind(this))}if(!t.getCurrentUser()&&!t.isAnonymousSession()){return t.startAnonymousSession()}}.bind(this)).then(function(){t()}).catch(function(e){console.error("Kidaptive ALP failed to initialize",e);t()})}.bind(this))};t.teardown=function(){this.alpPlugin.sdk.destroy().then(function(){delete this.alpPlugin}.bind(this))};var e=function(t,e,i){if(!(t instanceof Bellhop)){i(e)}var n=50;var o=null;var r=setTimeout(function(){if(o!==null){return}o=false;i(e)},n);t.fetch("alp_config",function(t){if(o!==null){return}o=true;i(Object.merge({},e,t.data))},null,true)}})();

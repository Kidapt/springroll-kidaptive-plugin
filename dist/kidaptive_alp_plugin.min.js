(function(){"use strict";var t=new springroll.ApplicationPlugin;t.preload=function(t){var i=function(t,i){return t instanceof Function&&t.bind(this)(i)||t}.bind(this);var e={options:{}};var n=function(t){Object.keys(t).forEach(function(i){if(i==="options"){Object.keys(t[i]).forEach(function(n){e.options[n]=t[i][n]})}else{e[i]=t[i]}})};if(this.config.alp){n(this.config.alp)}if(this.options.alp){n(this.options.alp)}var o=e.recType;var a=e.recParams;var r=e.recCallback;var s=e.gameUri;var c=e.eventOverride;var d=this.learning.catalog.events||{};KidaptiveSdk.init(e.apiKey,e.version,e.options).then(function(n){var l={};this.alpPlugin={sdk:n,getRecommendation:function(t){var e=n.KidaptiveUtils.copyObject(i(o,t)||"optimalDifficulty");var c=n.KidaptiveUtils.copyObject(i(a,t))||{};c.learnerId=n.getLearnerList()[0].id;c.game=s;var d;switch(e){case"random":d=n.getRandomRecommendations(c);break;case"optimalDifficulty":d=n.getOptimalDifficultyRecommendations(c);break;default:d=n.getRecommendations(e,c)}return r?r.bind(this)(d,t):d}.bind(this),getState:function(){return n.KidaptiveUtils.copyObject(l)},setState:function(t){Object.keys(t).forEach(function(i){if(t[i]===undefined){delete l[i]}});t=n.KidaptiveUtils.copyObject(t);Object.keys(t).forEach(function(i){l[i]=t[i]})},getInitParams:function(){return KidaptiveSdk.KidaptiveUtils.copyObject(e,true)}};if(!e.options.noOidc&&this.container){var u=function(t){if(n.KidaptiveUtils.getObject(t,["data","name"])!=="Kidaptive ALP"){return}n.init().then(function(){var t=n.KidaptiveUtils.getObject(n.getCurrentUser(),"id");if(n.isAnonymousSession()){n.logoutUser()}n.refresh().then(function(){var i=n.KidaptiveUtils.getObject(n.getCurrentUser(),"id");if(!i||i!==t){l={}}})})};var f=function(t){n.init().then(function(){if(!n.isAnonymousSession()&&n.KidaptiveUtils.getObject(t,["data","name"])==="Kidaptive ALP"){n.logoutUser().then(function(){l={}})}})};var p=function(){n.init().then(function(){if(n.isAnonymousSession()){n.logoutUser()}n.logoutUser().then(function(){l={}})})};this.container.on("openIdAuthSuccess",u);this.container.on("openIdRefreshAuthSuccess",u);this.container.on("openIdAuthFailure",f);this.container.on("openIdRefreshAuthFailure",f);this.container.on("openIdAllLogoutsComplete",p)}if(this.learning){var v=function(t){var i=d[t.event_data.event_code]||"Springroll Event";var e=n.KidaptiveUtils.copyObject(t.event_data);var o={additionalFields:e};o.gameUri=s;o.learnerId=n.getLearnerList()[0].id;for(var a in e){if(a==="duration"&&typeof e[a]==="number"){o[a]=e[a]/1e3;delete e[a]}else if(e[a]instanceof Object){e[a]=n.KidaptiveUtils.toJson(e[a])}else{e[a]=e[a].toString()}}e.springroll_game_id=t.game_id;e.springroll_event_id=t.event_id;e.springroll_event_code=e.event_code;delete e.event_code;n.reportBehavior(i,o)};var h=c||v;this.learning.on("learningEvent",function(t){n.init().then(function(){if(!n.getCurrentUser()&&!n.isAnonymousSession()){n.startAnonymousSession();l={}}h.bind(this)(t,v)}.bind(this))}.bind(this))}t()}.bind(this))};t.teardown=function(){this.alpPlugin.sdk.destroy().then(function(){delete this.alpPlugin}.bind(this))}})();

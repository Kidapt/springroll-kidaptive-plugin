KidaptiveAlpPlugin=new springroll.ApplicationPlugin;KidaptiveAlpPlugin.getReleaseStatus=function(e){return e&&e.playOptions&&e.playOptions.release};(function(){"use strict";var e=KidaptiveAlpPlugin;e.preload=function(e){var i=function(e,t){if(e instanceof Function){return e.bind(this)(t)}return e}.bind(this);var n={options:{}};var o=function(e){Object.keys(e).forEach(function(t){if(t==="options"){Object.keys(e[t]).forEach(function(i){n.options[i]=e[t][i]})}else{n[t]=e[t]}})};var a=KidaptiveAlpPlugin.getReleaseStatus(this)?"prod":"dev";var s=true;var r=false;if(this.config.alpEnvs&&this.config.alpEnvs[a]){o(this.config.alpEnvs[a]);s=false}else if(this.config.alp){o(this.config.alp);r=true}if(this.options.alpEnvs&&this.options.alpEnvs[a]){o(this.options.alpEnvs[a]);s=false}else if(this.options.alp){o(this.options.alp);r=true}if(r){console.warn("app.config.alp and app.options.alp are deprecated and may be removed in a future release. Use app.config.alpEnvs and app.options.alpEnvs instead")}if(r&&!s){console.warn("mixed usage of alp and alpEnv detected. alp_config will NOT be fetched from container")}var l=function(t){var n=t.recType;var o=t.recParams;var a=t.recCallback;var s=t.gameUri;var r=t.eventOverride;var l=this.learning.catalog.events||{};var c=KidaptiveSdk.KidaptiveUtils.copyObject(t.options)||{};c.autoFlushCallbacks=c.autoFlushCallbacks||[];c.autoFlushCallbacks.splice(0,0,function(e){e.then(function(){if(!KidaptiveSdk.getCurrentUser()&&!KidaptiveSdk.isAnonymousSession()){KidaptiveSdk.startAnonymousSession()}})});KidaptiveSdk.init(t.apiKey,t.version,c).then(function(e){var c={};this.alpPlugin={sdk:e,getRecommendation:function(t){var r=e.KidaptiveUtils.copyObject(i(n,t)||"optimalDifficulty");var l=e.KidaptiveUtils.copyObject(i(o,t))||{};l.learnerId=e.getLearnerList()[0].id;l.game=s;var c;switch(r){case"random":c=e.getRandomRecommendations(l);break;case"optimalDifficulty":c=e.getOptimalDifficultyRecommendations(l);break;default:c=e.getRecommendations(r,l)}return a?a.bind(this)(c,t):c}.bind(this),getState:function(){return e.KidaptiveUtils.copyObject(c)},setState:function(t){Object.keys(t).forEach(function(e){if(t[e]===undefined){delete c[e]}});t=e.KidaptiveUtils.copyObject(t);Object.keys(t).forEach(function(e){c[e]=t[e]})},getInitParams:function(){return KidaptiveSdk.KidaptiveUtils.copyObject(t,true)}};if(!t.options.noOidc&&this.container){var u=function(t){if(e.KidaptiveUtils.getObject(t,["data","name"])!=="Kidaptive ALP"){return}var i;e.init().then(function(){i=e.KidaptiveUtils.getObject(e.getCurrentUser(),"id");if(e.isAnonymousSession()){e.logoutUser()}return e.refresh()}).then(function(){var t=e.KidaptiveUtils.getObject(e.getCurrentUser(),"id");if(!t){throw new Error}if(t!==i){c={}}}).catch(function(){e.logoutUser();e.startAnonymousSession().then(function(){c={}})})};var p=function(t){if(e.KidaptiveUtils.getObject(t,["data","name"])!=="Kidaptive ALP"){return}e.init().then(function(){if(!e.isAnonymousSession()){e.logoutUser();e.startAnonymousSession().then(function(){c={}})}})};var f=function(){e.init().then(function(){if(e.isAnonymousSession()){e.logoutUser()}e.logoutUser();e.startAnonymousSession().then(function(){c={}})})};this.container.on("openIdAuthSuccess",u);this.container.on("openIdRefreshAuthSuccess",u);this.container.on("openIdAuthFailure",p);this.container.on("openIdRefreshAuthFailure",p);this.container.on("openIdAllLogoutsComplete",f)}if(this.learning){var d=function(t){if(!e.getCurrentUser()){return}var i=l[t.event_data.event_code]||"Springroll Event";var n=e.KidaptiveUtils.copyObject(t.event_data);var o={additionalFields:n};o.gameURI=s;o.learnerId=e.getLearnerList()[0].id;for(var a in n){if(a==="duration"&&typeof n[a]==="number"){o[a]=n[a]/1e3;delete n[a]}else if(n[a]instanceof Object){n[a]=e.KidaptiveUtils.toJson(n[a])}else{n[a]=n[a].toString()}}n.session_id=t.game_session;n.springroll_game_id=t.game_id;n.springroll_event_id=t.event_id;n.springroll_event_code=n.event_code;delete n.event_code;return{eventName:i,args:o}};var v=function(t){var i=d(t);if(i){e.reportBehavior(i.eventName,i.args)}};var h=(r||v).bind(this);this.learning.on("learningEvent",function(e){h(e,v,d)}.bind(this))}if(!e.getCurrentUser()&&!e.isAnonymousSession()){return e.startAnonymousSession()}}.bind(this)).then(function(){e()}).catch(function(t){console.error("Kidaptive ALP failed to initialize",t);e()})}.bind(this);if(s){t(this.container,n,l)}else{l(n)}};e.teardown=function(){this.alpPlugin.sdk.destroy().then(function(){delete this.alpPlugin}.bind(this))};var t=function(e,t,i){if(!(e instanceof Bellhop)){i(t)}var n=50;var o=null;var a=setTimeout(function(){if(o!==null){return}o=false;i(t)},n);e.fetch("alp_config",function(e){if(o!==null){return}o=true;i(Object.merge({},t,e.data))},null,true)}})();
